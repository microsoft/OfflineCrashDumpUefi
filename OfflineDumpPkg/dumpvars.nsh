@echo -off

if "%1" == "" or "%1" == "0" then
  echo UNENCRYPTED
  setvar OfflineMemoryDumpEncryptionAlgorithm -guid 77fa9abd-0359-4d32-bd60-28f4e78f784b -bs -rt -nv =00000000
  goto GoodArgs
endif
if "%1" == "1" then
  echo AES128_CTR
  setvar OfflineMemoryDumpEncryptionAlgorithm -guid 77fa9abd-0359-4d32-bd60-28f4e78f784b -bs -rt -nv =01000000
  goto GoodArgs
endif
if "%1" == "2" then
  echo AES192_CTR
  setvar OfflineMemoryDumpEncryptionAlgorithm -guid 77fa9abd-0359-4d32-bd60-28f4e78f784b -bs -rt -nv =02000000
  goto GoodArgs
endif
if "%1" == "3" then
  echo AES256_CTR
  setvar OfflineMemoryDumpEncryptionAlgorithm -guid 77fa9abd-0359-4d32-bd60-28f4e78f784b -bs -rt -nv =03000000
  goto GoodArgs
endif

echo Unrecognized ALG_ID %1.
echo This command sets the firmware variables needed for offline crash dump.
echo Usage: dumpvars ALG_ID
echo ALG_ID can be: 0 (UNENCRYPTED), 1 (AES128_CTR), 2 (AES192_CTR), 3 (AES256_CTR)
goto Done

:GoodArgs
setvar OfflineMemoryDumpUseCapability -guid 77fa9abd-0359-4d32-bd60-28f4e78f784b -bs -rt -nv =01
setvar OfflineMemoryDumpEncryptionPublicKey -guid 77fa9abd-0359-4d32-bd60-28f4e78f784b -bs -rt -nv =H308204be308202a6a003020102021014a4cc4e395de48c4df31edacf3c0206300d06092a864886f70d0101050500301b31193017060355040313104f66666c696e65437261736844756d70301e170d3235303232313231333533395a170d3430303130313030303030305a301b31193017060355040313104f66666c696e65437261736844756d7030820222300d06092a864886f70d01010105000382020f003082020a0282020100b5b8bbd6ce64bea03f4c80635a5240f2db6d18246cc7d77d921d277ec7f3072d1d46f69f7f10e822f402d10fb211d866a8a8e43c5d9baac3ef9e2d7802e751cd7357c50a369ce4cb6241dbaa9cdcd7e0aea08dc3e211292418073fb3fe2794532e0a0138d477ef2ebe5742712f18932773ea5763db08c57b3b315bf6af7b3c77ffbad51fa7a38fa873318c7148678da7f9ec3d058ce3688c50e6809ffc3d8fbdfc60405d7424de9d83b71c6f97e4e0d91392a7b9a9ab3e87d803f59b5d1b31077d2c51ca3dff8e0e4c7ef2b7907097063466ab9d182255e5605beaf5eccd979db4f64a62170bae7546de47dddc44a0545e4f728726271f2f346292cc26b6dd8c7c034946cdc81fa4f0145fe83f6ebe096ff01db98076dbdd593a73e89adf4c12fb62d04fe924bc2ae516cdbfdc2f994a9fa30a04e9cb9e7091767e241cd9cc3fdeec5f3613da81dd29ef429d6031d4f46d53b5a8b6d59ef2a321c69654f90d3ab2b9bd275b6a8d2934ef20a21648f67a951b69bad3bef5d05bd5420f54f2b8b9468bc5011b3e81a60781fb579a00175c01d608c1bf681b0af5e9d7d9656c63556783fb9cc4ca058b021260a702ed66b64790593d9873322577118d39971275acbc15cc83a43e49dcf3d388290849c68023669aede05ba136223c8c34dece1de4373f085673328fdbae83ffd3f148917e76bc0388a532ef57cd0a2c7324c5d38d0203010001300d06092a864886f70d0101050500038202010041b58c8a4d72dbfb90936975e376e2cda3905a1adea82d485f307892af874db442dbbc580afc8875927dfdf76d70d9215ce71eb287ffcfd20afac2a11664044ef0467dcd1235ea793824769f305956fed20af7f59d2f2f5b28401d690aee066f6c86c59979683b2b7e711cbe8c2ba4af92afbb21317b9804ac3c23d398038b0d9654ff8bfc8e4b861687b1834cdb9edeec19b211aa64e2fe08db6e47385a21333e938ad40a17021a3c8d773bc4ec92d8aa76e24b85438f8c77433ffc106291a5278d0ca28f5c0a7a965a4ed6b6de54dec5968b9e770df9299c1bde4775b7e72772f37ccb3cf55d50fecd8e724bb5d98b1f9c1e0f7468d71cc62df3b44cd15f38cad6d4340d2abaec48b1382fac40aebc7d6b51c80990a2db0cc543098e74077a00082ae26c13d6809f6399f5813f9228bbe8430af034c2bcc6031df5db48b3a89198f55c6f227d8aec2c21f52967e75738a7d6e6c6aa209e6c87a7f9c4999250069d4bcf82bc37e0ab038c511b4f63c037f2010274270e57f06d759d41d376e61b88192d4d0fba5bfbf62b482ba9ca9bf1eccc5133f58ba82dfb27aba588fef5c7f152938e34cf3452f1d30dadc0520e98026be17a261ee8460414567ec4d6ed6cafe646bdd28efc2b6fe592d681018557b95a189001ba32ea9b262b659c39873f7cf367efb1cde594f1b08705e14dbacf98e40377831f7779457db20142640e

if not %lasterror% == 0 then
  echo .
  echo Failed to set OfflineMemoryDumpEncryptionPublicKey (error %lasterror%). This
  echo may be due to the variable size limit. You may need to increase
  echo PcdMaxVariableSize, e.g. you may need to add
  echo "  gEfiMdeModulePkgTokenSpaceGuid.PcdMaxVariableSize|0x800"
  echo to the [PcdsFixedAtBuild] section of the platform's .dsc file.
  echo .
endif

:Done
